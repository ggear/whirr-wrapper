#!/bin/sh

WHIRR_TIME="$(date +%s)"

source "$WHIRR_WRAPPER_HOME"/bin/whirr.env

mkdir -p "$WHIRR_WRAPPER_HOME"/log
cd "$WHIRR_WRAPPER_HOME"/log

if [ $# -le 0 ]; then
	$WHIRR_HOME/bin/whirr
	exit 1
fi

CMD="$1"
shift

if [ "$CMD" != "launch" ] && [ ! $CLUSTER_LAUNCHED ]; then
  echo "Whirr cluster not initialised"
  exit 1
elif [ "$CMD" = "launch" ] && [ $CLUSTER_LAUNCHED ]; then
  echo "Whirr cluster already initialised"
  exit 1
fi

if [ "$CMD" = "launch" ]; then
  $WHIRR_HOME/bin/whirr "launch-cluster" --config ../cfg/$CLUSTER_NAME.properties
  $WHIRR_WRAPPER_HOME/bin/whirr-cm-init
  $WHIRR_WRAPPER_HOME/bin/whirr-client
  $WHIRR_WRAPPER_HOME/bin/whirr-list
elif [ "$CMD" = "destroy" ]; then
  $WHIRR_WRAPPER_HOME/bin/whirr-client-clean
  $WHIRR_WRAPPER_HOME/bin/whirr-umount
  $WHIRR_HOME/bin/whirr "destroy-cluster" --config ../cfg/$CLUSTER_NAME.properties
elif [ "$CMD" = "list" ]; then
  $WHIRR_WRAPPER_HOME/bin/whirr-list
elif [ "$CMD" = "cm-init" ]; then
  $WHIRR_WRAPPER_HOME/bin/whirr-cm-init
elif [ "$CMD" = "run" ]; then
  SCRIPT="$1"
  shift
  $WHIRR_HOME/bin/whirr "run-script" --config $WHIRR_WRAPPER_HOME/cfg/$CLUSTER_NAME.properties --script "$WHIRR_WRAPPER_HOME/opt/$SCRIPT.sh" "$@"  
elif [ "$CMD" = "mount" ]; then
  $WHIRR_WRAPPER_HOME/bin/whirr-mount
elif [ "$CMD" = "umount" ]; then
  $WHIRR_WRAPPER_HOME/bin/whirr-umount
elif [ "$CMD" = "client" ]; then
  $WHIRR_WRAPPER_HOME/bin/whirr-client
elif [ "$CMD" = "examples" ]; then
  $WHIRR_WRAPPER_HOME/bin/whirr-hadoop jar /usr/lib/hadoop-mapreduce/hadoop-mapreduce-examples.jar "$@" 
elif [ "$CMD" = "tests" ]; then
  $WHIRR_WRAPPER_HOME/bin/whirr-hadoop jar /usr/lib/hadoop-mapreduce/hadoop-mapreduce-client-jobclient-*-tests.jar "$@" 
elif [ "$CMD" = "hadoop" ]; then
  $WHIRR_WRAPPER_HOME/bin/whirr-hadoop "$@" 
elif [ "$CMD" = "help" ]; then
  $WHIRR_HOME/bin/whirr "help" "$@"
else
  $WHIRR_HOME/bin/whirr "$CMD" --config $WHIRR_WRAPPER_HOME/cfg/$CLUSTER_NAME.properties "$@"
fi

WHIRR_TIME="$(($(date +%s)-WHIRR_TIME))"
WHIRR_TIME_STRING=$(printf "Whirr completed in [%02d:%02d:%02d:%02d]\n" "$((WHIRR_TIME/86400))" "$((WHIRR_TIME/3600%24))" "$((WHIRR_TIME/60%60))" "$((WHIRR_TIME%60))") 
echo "" && echo "" && line_item_header "$WHIRR_TIME_STRING" && echo "" 