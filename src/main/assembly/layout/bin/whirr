#!/bin/sh

if [ -z "${WHIRR_HOME+xxx}" ]; then
  echo "WHIRR_HOME not set"
  exit 1
fi

if [ -z "${WHIRR_WRAPPER_HOME+xxx}" ]; then
  WHIRR_WRAPPER_HOME=$(pwd)/..
fi

source $WHIRR_WRAPPER_HOME/bin/whirr.env

mkdir -p "$WHIRR_WRAPPER_HOME"/log
cd "$WHIRR_WRAPPER_HOME"/log

if [ $# -le 0 ]; then
	$WHIRR_HOME/bin/whirr
	exit 1
fi

CMD="$1"
shift

if [ "$CMD" != "launch-cluster" ] && [ ! -d "$HOME/.whirr/$CLUSTER_NAME" ]; then
  echo "Whirr cluster not initialised"
  exit 1
elif [ "$CMD" = "launch-cluster" ] && [ -d "$HOME/.whirr/$CLUSTER_NAME" ]; then
  echo "Whirr cluster already initialised"
  exit 1
fi

if [ "$CMD" = "launch-cluster" ]; then
  $WHIRR_HOME/bin/whirr "launch-cluster" --config ../cfg/$CLUSTER_NAME.properties
  nohup $HOME/.whirr/$CLUSTER_NAME/hadoop-proxy.sh 1>&2 /dev/null &
  $WHIRR_WRAPPER_HOME/opt/cluster/list.sh
elif [ "$CMD" = "destroy-cluster" ]; then
  ps x | grep ssh | grep whirr | grep 6666 | grep -v grep |awk '{print $1}' | tr -s '\n' ' ' | sed 's/\(.*\)./\1/' | xargs -n 1 -I £ kill -9 £ 1>&2 /dev/null
  $WHIRR_HOME/bin/whirr "destroy-cluster" --config ../cfg/$CLUSTER_NAME.properties
elif [ "$CMD" = "list-cluster" ]; then
  $WHIRR_WRAPPER_HOME/opt/cluster/list.sh
else
  $WHIRR_HOME/bin/whirr "$CMD" --config ../cfg/$CLUSTER_NAME.properties "$@"
fi

