#!/bin/sh

DIR_BASE=/var/www/html/tmph3l7m2vv103
DIR_BASE_REPO=$DIR_BASE/cloudera-repos

mkdir -p $DIR_BASE_REPO
mkdir -p $WHIRR_WRAPPER_HOME/tmp

mkdir -p $DIR_BASE_REPO/cdh4/redhat/6/x86_64/cdh/4
cd $DIR_BASE_REPO/cdh4/redhat/6/x86_64/cdh
wget -N http://archive.cloudera.com/cdh4/redhat/6/x86_64/cdh/RPM-GPG-KEY-cloudera
cd $WHIRR_WRAPPER_HOME/tmp
[ ! -L $WHIRR_WRAPPER_HOME/tmp/cloudera-cdh4 ] && ln -s $DIR_BASE_REPO/cdh4/redhat/6/x86_64/cdh/4 $WHIRR_WRAPPER_HOME/tmp/cloudera-cdh4
reposync -r cloudera-cdh4
cd $WHIRR_WRAPPER_HOME/tmp/cloudera-cdh4
createrepo .
cd $DIR_BASE_REPO
wget -N -np -nH -r -l 2 -I "/*/*/[0-9].[0-9]*" -A json,el6.parcel http://archive.cloudera.com/cdh4/parcels/
rm -rf cdh4/parcels/latest
ln -s $PWD/$(dirname $(find cdh4/parcels -type f -printf '%T@ %p\n' | sort -n | tail -1 | cut -f2- -d" ")) cdh4/parcels/latest

mkdir -p $DIR_BASE_REPO/impala/redhat/6/x86_64/impala/1
cd $DIR_BASE_REPO/impala/redhat/6/x86_64/impala/1
wget -N http://archive.cloudera.com/impala/redhat/6/x86_64/impala/RPM-GPG-KEY-cloudera
cd $WHIRR_WRAPPER_HOME/tmp
[ ! -L $WHIRR_WRAPPER_HOME/tmp/cloudera-impala ] && ln -s $DIR_BASE_REPO/impala/redhat/6/x86_64/impala/1 $WHIRR_WRAPPER_HOME/tmp/cloudera-impala
reposync -r cloudera-impala
cd $WHIRR_WRAPPER_HOME/tmp/cloudera-impala
createrepo .
cd $DIR_BASE_REPO
wget -N -np -nH -r -l 2 -I "/*/*/[0-9].[0-9]*" -A json,el6.parcel http://archive.cloudera.com/impala/parcels/
rm -rf impala/parcels/latest
ln -s $PWD/$(dirname $(find impala/parcels -type f -printf '%T@ %p\n' | sort -n | tail -1 | cut -f2- -d" ")) impala/parcels/latest

mkdir -p $DIR_BASE_REPO/search/redhat/6/x86_64/search/0
cd $DIR_BASE_REPO/search/redhat/6/x86_64/search/0
wget -N http://archive.cloudera.com/search/redhat/6/x86_64/search/RPM-GPG-KEY-cloudera
cd $WHIRR_WRAPPER_HOME/tmp
[ ! -L $WHIRR_WRAPPER_HOME/tmp/cloudera-search ] && ln -s $DIR_BASE_REPO/search/redhat/6/x86_64/search/0 $WHIRR_WRAPPER_HOME/tmp/cloudera-search
reposync -r cloudera-search
cd $WHIRR_WRAPPER_HOME/tmp/cloudera-search
createrepo .
cd $DIR_BASE_REPO
wget -N -np -nH -r -l 2 -I "/*/*/[0-9].[0-9]*" -A json,el6.parcel http://archive.cloudera.com/search/parcels/
rm -rf search/parcels/latest
ln -s $PWD/$(dirname $(find search/parcels -type f -printf '%T@ %p\n' | sort -n | tail -1 | cut -f2- -d" ")) search/parcels/latest

mkdir -p $DIR_BASE_REPO/cm4/redhat/6/x86_64/cm/4
cd $DIR_BASE_REPO/cm4/redhat/6/x86_64/cm
wget -N http://archive.cloudera.com/cm4/redhat/6/x86_64/cm/RPM-GPG-KEY-cloudera
cd $WHIRR_WRAPPER_HOME/tmp
[ ! -L $WHIRR_WRAPPER_HOME/tmp/cloudera-manager ] && ln -s $DIR_BASE_REPO/cm4/redhat/6/x86_64/cm/4 $WHIRR_WRAPPER_HOME/tmp/cloudera-manager 
reposync -r cloudera-manager
cd $WHIRR_WRAPPER_HOME/tmp/cloudera-manager
createrepo .

find $DIR_BASE -type d -exec chmod -v 755 {} \;
find $DIR_BASE -type f -exec chmod -v 644 {} \;

rm -rf $WHIRR_WRAPPER_HOME/tmp/cloudera-*

